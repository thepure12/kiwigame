Kiwi.Plugins.BitmapText={name:"BitmapText",version:"1.0.2"},Kiwi.PluginManager.register(Kiwi.Plugins.BitmapText),"undefined"==typeof Kiwi.Plugins.GameObjects&&(Kiwi.Plugins.GameObjects={}),Kiwi.Plugins.GameObjects.BitmapText=function(a,b,c,d,e){Kiwi.Entity.call(this,a,d,e),"undefined"==typeof c&&(c=null),this._alphabeticalCells={a:26,A:0,b:27,B:1,c:28,C:2,d:29,D:3,e:30,E:4,f:31,F:5,g:32,G:6,h:33,H:7,i:34,I:8,j:35,J:9,k:36,K:10,l:37,L:11,m:38,M:12,n:39,N:13,o:40,O:14,p:41,P:15,q:42,Q:16,r:43,R:17,s:44,S:18,t:45,T:19,u:46,U:20,v:47,V:21,w:48,W:22,x:49,X:23,y:50,Y:24,z:51,Z:25,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,".":62,$:63,",":64,"!":65,"#":66," ":67},this.game.renderOption===Kiwi.RENDERER_WEBGL&&(this.glRenderer=this.game.renderer.requestSharedRenderer("TextureAtlasRenderer")),this.punctionationChars=[".","!","?",":",";",",","-"],this.defaultCell=67,this.bitmapTextAtlas=b,this.text=c,this.supported=!0,this._tempDirty=!0,this.maxWidth=null,this._width=0,this._lines=[],this.bitmapTextAtlas.type==Kiwi.Textures.TextureAtlas.SINGLE_IMAGE?(this.supported=!1,this.game.debugOption==Kiwi.DEBUG_ON&&console.log("Single Images will not work with the Bitmap Text GameObject!")):(this._tempCanvas=document.createElement("canvas"),this._tempCanvas.width=2,this._tempCanvas.height=2,this._tempCtx=this._tempCanvas.getContext("2d"),this._tempCanvasWidth=0,this._tempCanvasHeight=0,this._tempWord=[],this.atlas=new Kiwi.Textures.SingleImage(this.game.rnd.uuid(),this._tempCanvas),this.state.textureLibrary.add(this.atlas),this.atlas.dirty=!0)},Kiwi.extend(Kiwi.Plugins.GameObjects.BitmapText,Kiwi.Entity),Object.defineProperty(Kiwi.Plugins.GameObjects.BitmapText.prototype,"alphabeticalCells",{get:function(){return this._alphabeticalCells},set:function(a){this._tempDirty=!0,this._alphabeticalCells=a},enumerable:!0,configurable:!0}),Kiwi.Plugins.GameObjects.BitmapText.prototype.remap=function(a){for(var b in a)this.alphabeticalCells[b]=a[b]},Kiwi.Plugins.GameObjects.BitmapText.remap=function(a,b){for(var c in a)a[c].remap(b)},Object.defineProperty(Kiwi.Plugins.GameObjects.BitmapText.prototype,"text",{get:function(){return this._text},set:function(a){this._tempDirty=!0,this._text=a},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.GameObjects.BitmapText.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Kiwi.Plugins.GameObjects.BitmapText.prototype.update=function(){Kiwi.Entity.prototype.update.call(this)},Kiwi.Plugins.GameObjects.BitmapText.prototype.cellNumber=function(a){var b=this.alphabeticalCells[a];return"undefined"==typeof b?this.defaultCell:b},Kiwi.Plugins.GameObjects.BitmapText.prototype._singleLineText=function(){for(var a=0;a<this.text.length;a++){var b=this.bitmapTextAtlas.cells[this.cellNumber(this.text[a])];"undefined"!=typeof b&&null!==typeof b&&(b.h>this._tempCanvasHeight&&(this._tempCanvasHeight=b.h),this._tempCanvasWidth+=parseInt(b.w)),this._lines[this._lines.length-1].text.push(b)}},Kiwi.Plugins.GameObjects.BitmapText.prototype._multiLineText=function(){this._tempWord=[];for(var a=0;a<this.text.length;a++){var b=this.bitmapTextAtlas.cells[this.cellNumber(this.text[a])];if("undefined"!=typeof b&&null!==typeof b){(" "==this.text[a]||1==this._tempWord.length&&" "===this._tempWord[0].char)&&this._addTempWord();var c=this._tempCanvasWidth+parseInt(b.w);if(c>=this.maxWidth){this._tempCanvasWidth=0;for(var d=0;d<this._tempWord.length;d++)this._tempCanvasWidth+=parseInt(this._tempWord[d].cell.w);this._tempCanvasWidth+=parseInt(b.w),this._lines.push({text:[],height:0})}else this._tempCanvasWidth=c;this._lines[this._lines.length-1].height<b.h&&(this._lines[this._lines.length-1].height=b.h),this._tempWord.push({cell:b,"char":this.text[a],line:this._lines.length-1,cw:this._tempCanvasWidth}),-1!==this.punctionationChars.indexOf(this.text[a])&&this._addTempWord()}}this._addTempWord(),this._tempCanvasHeight=0;for(var a=0;a<this._lines.length;a++)this._tempCanvasHeight+=this._lines[a].height;this._lines.length>0&&(this._tempCanvasWidth=this.maxWidth)},Kiwi.Plugins.GameObjects.BitmapText.prototype._addTempWord=function(){if("undefined"!=typeof this._tempWord[0]&&this._tempWord[this._tempWord.length-1].line-this._tempWord[0].line>1)this._multiLineTextBreak();else{for(var a=0;a<this._tempWord.length;a++)this._lines[this._lines.length-1].text.push(this._tempWord[a].cell);this._tempWord.length=0}},Kiwi.Plugins.GameObjects.BitmapText.prototype._multiLineTextBreak=function(){var a=this._tempWord[this._tempWord.length-1].line-this._tempWord[0].line;this._lines.splice(this._lines.length-a,a),this._tempCanvasWidth=this._tempWord[0].cw-this._tempWord[0].cell.w;for(var b=0;b<this._tempWord.length;b++)this._tempCanvasWidth+=this._tempWord[b].cell.w,this._tempCanvasWidth>=this.maxWidth&&(this._tempCanvasWidth=this._tempWord[b].cell.w,this._lines.push({text:[],height:0})),this._lines[this._lines.length-1].height<this._tempWord[b].cell.h&&(this._lines[this._lines.length-1].height=this._tempWord[b].cell.h),this._lines[this._lines.length-1].text.push(this._tempWord[b].cell);this._tempWord.length=0},Kiwi.Plugins.GameObjects.BitmapText.prototype._renderText=function(){this._tempCanvasWidth=0,this._tempCanvasHeight=0,this._lines=[{text:[],height:0}],null==this.maxWidth?this._singleLineText():this._multiLineText(),this._width=this._tempCanvasWidth,this._renderToTempCanvas(),this.atlas.dirty=!0},Kiwi.Plugins.GameObjects.BitmapText.prototype._renderToTempCanvas=function(){if(this._tempCtx.clearRect(0,0,this._tempCanvas.width,this._tempCanvas.height),this.state.game.renderOption==Kiwi.RENDERER_WEBGL){if(-1==Kiwi.Utils.Common.base2Sizes.indexOf(this._tempCanvasWidth)){for(var a=0;this._tempCanvasWidth>Kiwi.Utils.Common.base2Sizes[a];)a++;this._tempCanvasWidth=Kiwi.Utils.Common.base2Sizes[a]}if(-1==Kiwi.Utils.Common.base2Sizes.indexOf(this._tempCanvasHeight)){for(var a=0;this._tempCanvasHeight>Kiwi.Utils.Common.base2Sizes[a];)a++;this._tempCanvasHeight=Kiwi.Utils.Common.base2Sizes[a]}}this._tempCanvas.width=this._tempCanvasWidth,this._tempCanvas.height=this._tempCanvasHeight;for(var b=0,c=0,d=0;d<this._lines.length;d++){for(var a=0;a<this._lines[d].text.length;a++){var e=this._lines[d].text[a];"undefined"!=typeof e&&(this._tempCtx.drawImage(this.bitmapTextAtlas.image,e.x,e.y,e.w,e.h,b,c,e.w,e.h),b+=parseInt(e.w))}b=0,c+=this._lines[d].height}this._tempDirty=!1},Kiwi.Plugins.GameObjects.BitmapText.prototype.render=function(){if(this.supported&&null!==this.text&&""!==this.text&&this.alpha>0&&this.visible){var a=this.game.stage.ctx;a.save();var b=this.transform;this.alpha>0&&this.alpha<=1&&(a.globalAlpha=this.alpha),this._tempDirty&&this._renderText();var c=b.getConcatenatedMatrix();a.setTransform(c.a,c.b,c.c,c.d,c.tx+b.rotPointX,c.ty+b.rotPointY),a.drawImage(this._tempCanvas,0,0,this._tempCanvas.width,this._tempCanvas.height,-b.rotPointX,-b.rotPointY,this._tempCanvas.width,this._tempCanvas.height),a.restore()}},Kiwi.Plugins.GameObjects.BitmapText.prototype.renderGL=function(){if(this.supported||null!=this.text||""!=this.text||0!=this.visible){this._tempDirty&&this._renderText();var a=[],b=[],c=this.transform,d=c.getConcatenatedMatrix(),e=new Kiwi.Geom.Point(0-c.rotPointX,0-c.rotPointY),f=new Kiwi.Geom.Point(this._tempCanvas.width-c.rotPointX,0-c.rotPointY),g=new Kiwi.Geom.Point(this._tempCanvas.width-c.rotPointX,this._tempCanvas.height-c.rotPointY),h=new Kiwi.Geom.Point(0-c.rotPointX,this._tempCanvas.height-c.rotPointY);e=d.transformPoint(e),f=d.transformPoint(f),g=d.transformPoint(g),h=d.transformPoint(h),a.push(e.x+c.rotPointX,e.y+c.rotPointY,0,0,f.x+c.rotPointX,f.y+c.rotPointY,this._tempCanvas.width,0,g.x+c.rotPointX,g.y+c.rotPointY,this._tempCanvas.width,this._tempCanvas.height,h.x+c.rotPointX,h.y+c.rotPointY,0,this._tempCanvas.height),b.push(this.alpha,this.alpha,this.alpha,this.alpha),this.glRenderer.concatBatch(a,b)}};